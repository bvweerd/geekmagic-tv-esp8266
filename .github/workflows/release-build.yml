name: Release Firmware Build and Publish

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "TAG=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update firmware version in code
        run: |
          sed -i 's/#define FIRMWARE_VERSION_STRING "dev"/#define FIRMWARE_VERSION_STRING "${{ steps.get_version.outputs.VERSION }}"/' src/settings.h
          echo "Updated settings.h with version ${{ steps.get_version.outputs.VERSION }}"
          grep "FIRMWARE_VERSION_STRING" src/settings.h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Build Firmware
        run: pio run -e nodemcuv2

      - name: Rename firmware binary
        run: |
          cp .pio/build/nodemcuv2/firmware.bin smartclock-${{ steps.get_version.outputs.TAG }}.bin
          ls -lh smartclock-${{ steps.get_version.outputs.TAG }}.bin

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: smartclock-${{ steps.get_version.outputs.TAG }}.bin
          tag_name: ${{ steps.get_version.outputs.TAG }}
          name: SmartClock Firmware ${{ steps.get_version.outputs.TAG }}
          body: |
            ## SmartClock Firmware Release ${{ steps.get_version.outputs.TAG }}

            ### Installation
            1. Download the `smartclock-${{ steps.get_version.outputs.TAG }}.bin` file
            2. Go to your SmartClock web interface
            3. Navigate to "Advanced Actions" â†’ "Firmware Update (OTA)"
            4. Upload the downloaded binary file
            5. Wait for the update to complete and the device to restart

            ### What's Changed
            - Firmware version: ${{ steps.get_version.outputs.VERSION }}

            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
